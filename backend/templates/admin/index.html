<!DOCTYPE html>
<html>
<head>
    <title>报告管理系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        .container {
            padding: 20px;
        }
        .header {
            margin-bottom: 20px;
        }
        .upload-form {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .search-form {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-container>
            <el-header>
                <div class="header">
                    <h2>报告管理系统</h2>
                    <el-button type="text" @click="logout" v-if="isLoggedIn">退出登录</el-button>
                </div>
            </el-header>
            
            <el-main>
                <!-- 登录表单 -->
                <div v-if="!isLoggedIn" class="login-form">
                    <el-form :model="loginForm" label-width="80px">
                        <el-form-item label="用户名">
                            <el-input v-model="loginForm.username"></el-input>
                        </el-form-item>
                        <el-form-item label="密码">
                            <el-input type="password" v-model="loginForm.password"></el-input>
                        </el-form-item>
                        <el-form-item>
                            <el-button type="primary" @click="login">登录</el-button>
                        </el-form-item>
                    </el-form>
                </div>

                <!-- 管理界面 -->
                <div v-else class="container">
                    <el-tabs v-model="activeTab" v-if="isLoggedIn">
                        <el-tab-pane label="报告管理" name="reports">
                            <!-- 上传报告 -->
                            <div class="upload-form">
                                <h3>上传报告</h3>
                                <el-form :model="uploadForm" label-width="80px">
                                    <el-form-item label="手机号">
                                        <el-input v-model="uploadForm.phone"></el-input>
                                    </el-form-item>
                                    <el-form-item label="报告文件">
                                        <el-upload
                                            :action="uploadUrl"
                                            :headers="uploadHeaders"
                                            :on-success="handleUploadSuccess"
                                            :on-error="handleUploadError"
                                            :data="{ phone: uploadForm.phone }"
                                            accept=".pdf">
                                            <el-button size="small" type="primary">选择文件</el-button>
                                        </el-upload>
                                    </el-form-item>
                                </el-form>
                            </div>

                            <!-- 查询报告 -->
                            <div class="search-form">
                                <h3>查询报告</h3>
                                <el-form :inline="true" :model="searchForm">
                                    <el-form-item label="手机号">
                                        <el-input v-model="searchForm.phone"></el-input>
                                    </el-form-item>
                                    <el-form-item>
                                        <el-button type="primary" @click="searchReports">查询</el-button>
                                    </el-form-item>
                                </el-form>
                            </div>

                            <!-- 报告列表 -->
                            <el-table :data="reports" style="width: 100%">
                                <el-table-column prop="filename" label="文件名"></el-table-column>
                                <el-table-column prop="upload_time" label="上传时间"></el-table-column>
                                <el-table-column label="操作">
                                    <template slot-scope="scope">
                                        <el-button size="mini" type="danger" @click="deleteReport(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </el-tab-pane>
                        
                        <el-tab-pane label="用户管理" name="users">
                            <div class="users-container">
                                <div class="search-form">
                                    <el-input
                                        v-model="userSearch"
                                        placeholder="搜索手机号"
                                        @keyup.enter.native="searchUsers">
                                        <el-button slot="append" icon="el-icon-search" @click="searchUsers"></el-button>
                                    </el-input>
                                </div>
                                
                                <el-table :data="users" style="width: 100%">
                                    <el-table-column prop="phone" label="手机号"></el-table-column>
                                    <el-table-column prop="reports_count" label="报告数量"></el-table-column>
                                    <el-table-column prop="last_report" label="最近报告时间"></el-table-column>
                                    <el-table-column label="操作" width="150" v-if="isSuperAdmin">
                                        <template slot-scope="scope">
                                            <el-button
                                                size="mini"
                                                type="danger"
                                                @click="deleteUser(scope.row.id)">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                                
                                <el-pagination
                                    @current-change="handleUserPageChange"
                                    :current-page="userPage"
                                    :page-size="10"
                                    :total="userTotal"
                                    layout="total, prev, pager, next">
                                </el-pagination>
                            </div>
                        </el-tab-pane>
                        
                        <el-tab-pane label="管理员管理" name="admins" v-if="isSuperAdmin">
                            <div class="admins-container">
                                <el-button type="primary" @click="showAddAdminDialog">添加管理员</el-button>
                                
                                <el-table :data="admins" style="width: 100%; margin-top: 20px;">
                                    <el-table-column prop="username" label="用户名"></el-table-column>
                                    <el-table-column prop="is_super_admin" label="超级管理员">
                                        <template slot-scope="scope">
                                            <el-tag :type="scope.row.is_super_admin ? 'success' : ''">
                                                {{scope.row.is_super_admin ? '是' : '否'}}
                                            </el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="created_at" label="创建时间"></el-table-column>
                                    <el-table-column prop="last_login" label="最后登录"></el-table-column>
                                    <el-table-column label="操作" width="150">
                                        <template slot-scope="scope">
                                            <el-button
                                                size="mini"
                                                type="danger"
                                                @click="deleteAdmin(scope.row.id)"
                                                v-if="scope.row.id !== currentAdminId">删除</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                            
                            <!-- 添加管理员对话框 -->
                            <el-dialog title="添加管理员" :visible.sync="addAdminDialogVisible">
                                <el-form :model="addAdminForm" label-width="100px">
                                    <el-form-item label="用户名">
                                        <el-input v-model="addAdminForm.username"></el-input>
                                    </el-form-item>
                                    <el-form-item label="密码">
                                        <el-input type="password" v-model="addAdminForm.password"></el-input>
                                    </el-form-item>
                                    <el-form-item label="超级管理员">
                                        <el-switch v-model="addAdminForm.is_super_admin"></el-switch>
                                    </el-form-item>
                                </el-form>
                                <div slot="footer">
                                    <el-button @click="addAdminDialogVisible = false">取消</el-button>
                                    <el-button type="primary" @click="addAdmin">确定</el-button>
                                </div>
                            </el-dialog>
                        </el-tab-pane>
                    </el-tabs>
                </div>
            </el-main>
        </el-container>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                isLoggedIn: false,
                loginForm: {
                    username: '',
                    password: ''
                },
                uploadForm: {
                    phone: ''
                },
                searchForm: {
                    phone: ''
                },
                reports: [],
                token: '',
                activeTab: 'reports',
                userSearch: '',
                userPage: 1,
                userTotal: 0,
                isSuperAdmin: false,
                addAdminDialogVisible: false,
                addAdminForm: {
                    username: '',
                    password: '',
                    is_super_admin: false
                }
            },
            computed: {
                uploadUrl() {
                    return '/api/admin/reports/upload'
                },
                uploadHeaders() {
                    return {
                        'Authorization': `Bearer ${this.token}`
                    }
                }
            },
            methods: {
                async login() {
                    try {
                        const res = await axios.post('/api/admin/login', this.loginForm)
                        this.token = res.data.token
                        this.isLoggedIn = true
                        localStorage.setItem('admin_token', this.token)
                    } catch (err) {
                        this.$message.error('登录失败')
                    }
                },
                logout() {
                    this.isLoggedIn = false
                    this.token = ''
                    localStorage.removeItem('admin_token')
                },
                async searchReports() {
                    try {
                        const res = await axios.get('/api/admin/reports/search', {
                            params: { phone: this.searchForm.phone },
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.reports = res.data.reports
                    } catch (err) {
                        this.$message.error('查询失败')
                    }
                },
                async deleteReport(reportId) {
                    try {
                        await axios.delete(`/api/admin/reports/${reportId}`, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.$message.success('删除成功')
                        this.searchReports()
                    } catch (err) {
                        this.$message.error('删除失败')
                    }
                },
                handleUploadSuccess() {
                    this.$message.success('上传成功')
                    this.uploadForm.phone = ''
                },
                handleUploadError() {
                    this.$message.error('上传失败')
                },
                async searchUsers() {
                    try {
                        const res = await axios.get('/api/admin/users/search', {
                            params: { phone: this.userSearch },
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.users = res.data.users
                        this.userTotal = res.data.total
                    } catch (err) {
                        this.$message.error('查询失败')
                    }
                },
                async deleteUser(userId) {
                    try {
                        await axios.delete(`/api/admin/users/${userId}`, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.$message.success('删除成功')
                        this.searchUsers()
                    } catch (err) {
                        this.$message.error('删除失败')
                    }
                },
                handleUserPageChange(page) {
                    this.userPage = page
                    this.searchUsers()
                },
                async addAdmin() {
                    try {
                        const res = await axios.post('/api/admin/admins', this.addAdminForm, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.$message.success('添加成功')
                        this.addAdminDialogVisible = false
                        this.addAdminForm = {
                            username: '',
                            password: '',
                            is_super_admin: false
                        }
                        this.getAdmins()
                    } catch (err) {
                        this.$message.error('添加失败')
                    }
                },
                async getAdmins() {
                    try {
                        const res = await axios.get('/api/admin/admins', {
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.admins = res.data.admins
                    } catch (err) {
                        this.$message.error('获取管理员列表失败')
                    }
                },
                async deleteAdmin(adminId) {
                    try {
                        await axios.delete(`/api/admin/admins/${adminId}`, {
                            headers: { Authorization: `Bearer ${this.token}` }
                        })
                        this.$message.success('删除成功')
                        this.getAdmins()
                    } catch (err) {
                        this.$message.error('删除失败')
                    }
                }
            },
            mounted() {
                const token = localStorage.getItem('admin_token')
                if (token) {
                    this.token = token
                    this.isLoggedIn = true
                }
            }
        })
    </script>
</body>
</html> 